

ALTER view [dbo].[V_CLEAR_CHECK]
AS    
(
		SELECT  cl.OPR_DATE, PAYEE_NAME,  CHECK_NUMBER, CHECK_TYPE,  DEBIT_CREDIT, 
		REMARK, VALUE_TYPE,
		cl.ENTRY_LOC, ct.CHECKTYPE_NAME
		FROM CLEARINGTAB cl
		INNER JOIN CHECKTOTAL cht
		ON cht.MID=cl.MID
		LEFT OUTER JOIN CHECKTYPE ct
		ON ct.CHECKTYPE_CODE=cl.CHECK_TYPE
		WHERE cht.[STATUS]='L'
)

GO




ALTER view [dbo].[V_CLEAR_CHECK_BANK]
AS    
(
		SELECT  cl.OPR_DATE, ISSUE_DATE, cl.NIKBRANCH_CODE, CHECK_NUMBER, CHECK_TYPE,  
		DEBIT_CREDIT, VALUE_TYPE,
		cl.ENTRY_LOC, ct.CHECKTYPE_NAME,cb.BANK_CODE,cb.BANK_NAME
		FROM CLEARINGTAB cl
		INNER JOIN CHECKTOTAL cht
		ON cht.MID=cl.MID
		LEFT OUTER JOIN CHECKTYPE ct
		ON ct.CHECKTYPE_CODE=cl.CHECK_TYPE
		LEFT OUTER JOIN CLEARING_BRANCH cbr
		ON cbr.NIKBRANCH_CODE=cl.NIKBRANCH_CODE
		LEFT OUTER JOIN CLEARING_BANK cb
		ON cb.BANK_CODE=cbr.BANK_CODE
		WHERE cht.[STATUS]='L'
		
)

GO



ALTER view [dbo].[V_CLEAR_DEPOSIT]
AS    
(
		SELECT ct.TOTAL_CHKNO, ct.TOTAL_CHKAMT, ISNULL(ct.CUSTOMER_REF,'') CUSTOMER_REF,
		VALUE_TYPE,
		cl.OPR_DATE, cl.NIKBRANCH_CODE,cl.PAYEE_NAME, cl.CHECK_NUMBER, 
		cl.CHECK_TYPE, cl.DEBIT_CREDIT, cl.REMARK,cl.CHECK_REF,cl.DS_CODE, 
		cl.RTN_STATUS,cl.ENTRY_LOC,cl.IS_PDC,
		cbr.BRANCH_NAME,cb.BANK_CODE,cb.BANK_NAME
		FROM CHECKTOTAL ct
		INNER JOIN CLEARINGTAB cl
		ON ct.DS_CODE=cl.DS_CODE AND ct.OPR_DATE=cl.OPR_DATE 
		AND ct.ENTRY_LOC=cl.ENTRY_LOC
		LEFT OUTER JOIN CLEARING_BRANCH cbr
		ON cbr.NIKBRANCH_CODE=cl.NIKBRANCH_CODE
		LEFT OUTER JOIN CLEARING_BANK cb
		ON cb.BANK_CODE=cbr.BANK_CODE
		WHERE ct.[STATUS]='L'
)

GO




-- =============================================
-- Author:		Iftekharul Alam Khan Lodi
-- Create date: 02-Oct-13
-- Description: Process for clearing return 
-- =============================================

ALTER PROCEDURE [dbo].[CMS_Process_ClearingRetGenerate]
	@OPR_DATE	datetime,	
	@ENTRY_LOC	varchar(3)
AS
BEGIN	
	
	DELETE FROM TMP_RETURN_CLEARING 
		WHERE ENTRY_LOC=@ENTRY_LOC ;


	INSERT INTO TMP_RETURN_CLEARING(OPR_DATE, REMARK, ACC_NO, AMOUNT, ENTRY_LOC, 
	INSTRUMENT, ADDTEXT, RULETYPE)            

	SELECT ct.OPR_DATE,
	ct.REMARK,ct.REMARK AS 'ACC_NO', SUM(rc.AMOUNT) AMOUNT,ct.ENTRY_LOC,
	'' AS 'INSTRUMENT',
	CONVERT(varchar(15),COUNT(ct.MID))  AS  'ADDTEXT', '1' AS 'RULETYPE'
		FROM CLEARINGTAB ct
		INNER JOIN CHECKTOTAL c ON c.MID=ct.MID
		INNER JOIN RETURN_CLEARING rc
		ON ct.MID=rc.MID AND ct.DSL=rc.DSL		
		WHERE 
		rc.[STATUS]='L'
		AND ct.RTN_STATUS='R' AND c.[STATUS]='L'
		AND ct.OPR_DATE =@OPR_DATE AND ct.ENTRY_LOC=@ENTRY_LOC
		AND SUBSTRING(ct.REMARK,7,6) IN ('200282','200274')
		GROUP BY ct.REMARK,ct.ENTRY_LOC,ct.OPR_DATE
		
	UNION ALL
		
	SELECT ct.OPR_DATE,
	ct.REMARK,'010009155130005' AS 'ACC_NO',SUM(rc.AMOUNT) AMOUNT,ct.ENTRY_LOC,
	'' AS 'INSTRUMENT',
	CONVERT(varchar(15),COUNT(ct.MID))  AS  'ADDTEXT' ,'2' AS 'RULETYPE'
		FROM CLEARINGTAB ct
		INNER JOIN CHECKTOTAL c ON c.MID=ct.MID
		INNER JOIN RETURN_CLEARING rc
		ON ct.MID=rc.MID AND ct.DSL=rc.DSL		
		WHERE 
		rc.[STATUS]='L'
		AND ct.RTN_STATUS='R' AND c.[STATUS]='L'
		AND ct.OPR_DATE =@OPR_DATE AND ct.ENTRY_LOC=@ENTRY_LOC
		AND ct.REMARK IN ('010001200038017','010001200038018')
		GROUP BY ct.REMARK,ct.ENTRY_LOC,ct.OPR_DATE
	
	UNION ALL
	
	SELECT ct.OPR_DATE,
	ct.REMARK,'010009155220004' AS 'ACC_NO',SUM(rc.AMOUNT) AMOUNT,ct.ENTRY_LOC,
	'' AS 'INSTRUMENT',
	CONVERT(varchar(15),COUNT(ct.MID))  AS  'ADDTEXT' ,'2' AS 'RULETYPE'
		FROM CLEARINGTAB ct
		INNER JOIN CHECKTOTAL c ON c.MID=ct.MID
		INNER JOIN RETURN_CLEARING rc
		ON ct.MID=rc.MID AND ct.DSL=rc.DSL		
		WHERE 
		rc.[STATUS]='L'
		AND ct.RTN_STATUS='R' AND c.[STATUS]='L'
		AND ct.OPR_DATE =@OPR_DATE AND ct.ENTRY_LOC=@ENTRY_LOC
		AND ct.REMARK='010009275590007'
		GROUP BY ct.REMARK,ct.ENTRY_LOC,ct.OPR_DATE
		
	UNION ALL
		
		SELECT ct.OPR_DATE,
	ct.REMARK,ct.REMARK AS 'ACC_NO',rc.AMOUNT,ct.ENTRY_LOC,
	ct.CHECK_NUMBER AS 'INSTRUMENT',
	b.BANK_NAME + '(' + cb.BRANCH_NAME + ') '  AS 'ADDTEXT' ,'3' AS 'RULETYPE'
		FROM CLEARINGTAB ct
		INNER JOIN CHECKTOTAL c ON c.MID=ct.MID
		INNER JOIN RETURN_CLEARING rc		
		ON ct.MID=rc.MID AND ct.DSL=rc.DSL
		INNER JOIN CLEARING_BRANCH cb ON cb.NIKBRANCH_CODE=ct.NIKBRANCH_CODE
		INNER JOIN CLEARING_BANK b ON b.BANK_CODE=cb.BANK_CODE
		WHERE 
		rc.[STATUS]='L'
		AND ct.RTN_STATUS='R' AND c.[STATUS]='L'
		AND ct.OPR_DATE =@OPR_DATE AND ct.ENTRY_LOC=@ENTRY_LOC
		AND ct.REMARK NOT IN ('010001200038017','010001200038018','010009275590007')
		AND SUBSTRING(ct.REMARK,7,6) NOT IN ('200282','200274')
		                                 
	
         
END

GO



ALTER view [dbo].[V_MONTH_BILL]      
AS    
(
	SELECT DS_CODE, D_CODE, CITICASH_AMOUNT, CITICHECK_AMOUNT, SCHEDULE_DATE, 
		CLIENT_CODE, LOCATION_CODE, LOCATION_NAME, ACC_NAME, 
		CASH_CHARGE,(CASH_CHARGE/1000*CITICASH_AMOUNT) AS C_CASH_CHARGE, 
		SPEED_CHARGE,(SPEED_CHARGE/1000*(CITICHECK_AMOUNT-RETURN_AMOUNT)) AS C_SPEED_CHARGE, 
		RETURN_CHARGE,(RETURN_CHARGE*NO_OF_RETURN) AS C_RETURN_CHARGE , CASH_STD_CHARGE, 
		SPEED_STD_CHARGE, CASH_VAT,((CASH_STD_CHARGE/1000*CITICASH_AMOUNT)*CASH_VAT/100) AS C_CASH_VAT,
		SPEED_VAT, ((SPEED_STD_CHARGE/1000*(CITICHECK_AMOUNT-RETURN_AMOUNT))*SPEED_VAT/100) AS C_SPEED_VAT,
		RETURN_AMOUNT, NO_OF_RETURN,(RETURN_CHARGE*NO_OF_RETURN)*SPEED_VAT/100 AS C_RETURN_VAT
		FROM TMP_MON_BILL
)

GO




-- =============================================
-- Author:		Iftekharul Alam Khan Lodi
-- Create date: 30-Oct-13
-- Description:	Add Return Check having same check info
-- =============================================
CREATE PROCEDURE [dbo].[CMS_ReturnClearing_AddDup]	
	@MID			numeric(10,0),
	@DSL			numeric(4,0),	
	@CHECK_NUMBER	varchar(15),
	@AMOUNT			numeric(14,2),
	@RTN_CODE		varchar(2),
	@OPR_DATE		datetime,
	@SEQ_NUMBER		varchar(50)		
AS
BEGIN	
	
	DECLARE
		@v_cnt	int;
	
		SELECT @v_cnt=COUNT(*)
			FROM CLEARINGTAB ct											
			WHERE ct.CHECK_NUMBER=@CHECK_NUMBER AND ct.DEBIT_CREDIT=@AMOUNT
			AND OPR_DATE=@OPR_DATE AND ct.MID=@MID AND ct.DSL=@DSL;
		
		IF @v_cnt=0
		BEGIN
			RETURN 4;			
		END
				
		INSERT INTO RETURN_CLEARING(MID, DSL, CHECK_NUMBER, AMOUNT, RTN_CODE, 
			OPR_DATE, SEQ_NUMBER,
			INPUT_BY, 
			INPUT_DATETIME, INPUT_FROM, [STATUS])
			VALUES(@MID, @DSL, @CHECK_NUMBER, @AMOUNT, @RTN_CODE, 
			@OPR_DATE,@SEQ_NUMBER,  
			substring(suser_name(),charindex('\',suser_name())+1,20),
			GETDATE(),HOST_NAME(), 'U')

		RETURN 0;

		
END


GO



GRANT EXECUTE ON [dbo].[CMS_ReturnClearing_AddDup] TO [ccms_sp_only]

GO




-- =============================================
-- Author:		Iftekharul Alam Khan Lodi
-- Create date: 30-Oct-13
-- Description:	Remove record from bank table
-- =============================================
CREATE PROCEDURE [dbo].[CMS_ReturnClearing_Remove]	
	@MID			numeric(10,0),
	@DSL			numeric(4,0)
AS
BEGIN	
	DECLARE @STATUS			char(1);			
	
	DECLARE @ErrorVar		int; 
			
	SET NOCOUNT ON;

	SET @STATUS = '';

	BEGIN TRANSACTION

	IF EXISTS(SELECT MID FROM RETURN_CLEARING
			  WHERE MID=@MID AND DSL=@DSL)
		BEGIN
			SELECT @STATUS=[STATUS]
				FROM RETURN_CLEARING 
				WHERE MID=@MID AND DSL=@DSL;
			
			IF (@STATUS = 'L')
				BEGIN
					-- authorized data
					ROLLBACK TRANSACTION;
					RETURN 3;
				END;

			DELETE RETURN_CLEARING
			  WHERE MID=@MID AND DSL=@DSL;

			SELECT @ErrorVar = @@ERROR;		

			IF @ErrorVar <> 0				
				BEGIN
					ROLLBACK TRANSACTION;
					RETURN 1;
				END

			
			COMMIT TRANSACTION;
			RETURN 0;
				
		END;
	ELSE 
		BEGIN			
			
			-- not exist
			ROLLBACK TRANSACTION;
			RETURN 4;
		
		END		
    
END

GO


GRANT EXECUTE ON [dbo].[CMS_ReturnClearing_Remove] TO [ccms_sp_only]

GO












